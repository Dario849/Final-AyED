<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="js/bootstrap-5.3.8-dist/css/bootstrap.min.css">
    <link href="js/bootstrap-5.3.8-dist/bootstrap-icons-1.13.1/bootstrap-icons.css" rel="stylesheet">
    <script src="js/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/sweetalert2-11.26.2/package/dist/sweetalert2.all.min.js"></script>
    <title>Service de vehículos</title>
</head>
<style>
    .sortable {
        cursor: pointer;
    }

    .sortable.asc::after {
        content: " \25B2";
        /* Up arrow */
    }

    .sortable.desc::after {
        content: " \25BC";
        /* Down arrow */
    }
</style>

<body class="p-3 mb-2 bg-secondary bg-gradient text-white">
    <div>
        <div class="card-header text-center fw-semibold">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Listado de clientes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="services.html">Listado de servicios</a>
                </li>
            </ul>
        </div>
        <div class="card-body p-0">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Filtro de busqueda:</span>
                </div>
                <input type="text" readonly class="form-control" placeholder="Seleccione un filtro primero"
                    id="InputFilterTable">
                <select class="custom-select" id="SelectFilterTable">
                    <option selected value="">⇓ FILTRO ⇓</option>
                    <option value="servicio N°">Numero de Service</option>
                    <option value="Patente">Patente</option>
                    <option value="Modelo">Modelo</option>
                    <option value="Importe">importe</option>
                    <option value="Estado">Estado</option>
                    <option value="dni">DNI</option>
                </select>

            </div>
            <table id="tableServices" class="table table-bordered table-striped table-hover align-middle mb-0">
                <thead class="table-primary text-center">
                    <tr>
                        <th class="col-sm-1 sortable">Servicio N°</th>
                        <th class="col col-sm-auto sortable">Nombre y apellido</th>
                        <th class="col col-sm-auto sortable">DNI</th>
                        <th class="col col-sm-1 sortable">Patente</th>
                        <th class="col sortable">Modelo</th>
                        <th class="col sortable">Importe</th>
                        <th class="col sortable">Fecha</th>
                        <th class="col-auto sortable">Fecha último cambio</th>
                        <th class="col-auto sortable">Estado</th>
                    </tr>
                </thead>
                <tbody id="listServices" role="button">
                    <tr>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                    </tr>
                </tbody>
            </table>
            <div class="modal fade" id="showServiceModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="detailServicePanel">Detalles y configuración de servicio:</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-1 ">
                            <div class="table-responsive">
                                <table id="tableListStock"
                                    class="table align-middle table-bordered table-striped table-hover table-sm">
                                    <thead class="table-primary text-center" id="serviceTableHeadDetails">
                                        <tr>
                                            <th>Trabajo N°</th>
                                            <th>Detalle de trabajo</th>
                                            <th>Importe</th>
                                            <th>Cantidad</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider" id="listServiceDetails"></tbody>
                                </table>
                            </div>
                            <div id="serviceActions">
                                <span>Añadir nuevos trabajos al servicio</span>
                                <div style="border: 1px solid black; padding: 1vh; border-radius: 3px;">
                                    <select id="selectTrabajosList">
                                        <option value="0" Disabled selected>Seleccionar trabajos</option>
                                    </select>
                                    <button id="btnCountNewJobToService" data-count="1"
                                        onclick="countNewJobToService(this)"><strong>+</strong><span
                                            id="showCountVal">1</span></button>
                                    <button id="subCountNewJobToService"
                                        onclick="countNewJobToService(this)"><strong>-</strong></button>
                                    <button id="btnAddNewJobToService" class="btn btn-success">Añadir nuevo
                                        trabajo</button>
                                </div>
                                <span>Modificar estado del trabajo</span>
                                <div style="border: 1px solid black; padding: 1vh; border-radius: 3px;">
                                    Estado actual: <strong id="spanCurrentState">Entregado</strong>
                                    <button class="btn btn-success" onclick="changeServiceState(this)">Cambiar a estado:
                                        <span style="color: blue;" id="showNextState">Terminado</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                $(function () { // obtiene valores GET en caso de que provenga de menú de clientes
                    const urlParams = new URLSearchParams(window.location.search);
                    const serviceId = urlParams.get('id');
                    const isService = urlParams.get('isservice');
                    if (!isNaN(serviceId) && isService === 'true') {
                        loadServiceData(serviceId);
                    }
                });
                loadAllServices();
                $(".modal").on("hidden.bs.modal", function () { // limpiar campos, y cargar lista de servicios al ocultar el modal
                    $(this).find("input, textarea").val("");
                    loadAllServices();
                });
                $('#SelectFilterTable').change(function (e) {// notifica a usuario si no tiene filtro seleccionado
                    if ($('#SelectFilterTable').val() == '') {
                        loadAllProducts();
                        $("#InputFilterTable").attr({
                            'readonly': true,
                            placeholder: 'Seleccione un filtro primero'
                        });
                    } else {
                        $("#InputFilterTable").show();
                        $("#InputFilterTable").attr({
                            'readonly': false,
                            placeholder: ''
                        });
                    }
                });
                $("#InputFilterTable").on('input', function () {// filtrado generico de tabla según input text, y selección de columna a fitrar
                    var filter = $(this).val().toUpperCase();
                    var selected = $("#SelectFilterTable").val(); // valor del <select>
                    var tableHead = $("#tableServices");
                    var tableBody = $("#listServices");
                    var tr = tableBody.find("tr");
                    // índice de columna según encabezado
                    var index = -1;
                    if (selected) {
                        tableHead.find("th").each(function (i) {
                            if ($(this).text().toLowerCase() === selected.toLowerCase()) {
                                index = i;
                                return false;
                            }
                        });
                    }

                    tr.each(function () {
                        var tds = $(this).find("td");
                        var found = false;

                        if (index >= 0 && tds.eq(index).length) {
                            // filtra solo por la columna seleccionada
                            var txt = tds.eq(index).text();
                            found = txt.toUpperCase().indexOf(filter) > -1;
                        } else {
                            // si no hay selección, busca en todas las columnas
                            tds.each(function () {
                                if ($(this).text().toUpperCase().indexOf(filter) > -1) {
                                    found = true;
                                    return false;
                                }
                            });
                        }
                        $(this).toggle(found);
                    });
                });
                function loadAllServices() {//Cargar todos los servicios disponibles
                    $.ajax({
                        type: "POST",
                        url: "backend/collector.php",
                        data: { action: "servicios_list" },
                        dataType: "json",
                        success: function (response) {
                            $("#listServices").empty();
                            $.each(response.data, function (index, content) {
                                buttonPlus = $("<button>").attr({
                                    id: "add_" + content.id,
                                    class: "btn btn-sm btn-success me-1",
                                    onclick: "modalAdd(this, " + content.id + ")",
                                });
                                buttonPlus.html('<i class="bi bi-plus-lg"></i>');
                                buttonMinus = $("<button>").attr({
                                    id: "substract_" + content.id,
                                    class: "btn btn-sm btn-danger",
                                    onclick: "modalSubstract(this, " + content.id + ")",
                                });
                                buttonMinus.html('<i class="bi bi-dash-lg"></i>');
                                tr = $("<tr>");
                                tr.append(
                                    $("<td>")
                                        .text(content.id)
                                        .attr({
                                            onclick: "loadServiceData(" + content.id + ")",
                                            id: content.id,
                                        })
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.apellido_nombre)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.DNI)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.patente)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.nombre)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.importe)
                                        .attr({
                                            onclick: "loadServiceData(" + content.id + ")",
                                            class: "text-end"
                                        })
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.fecha)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                //CONDICIONAL, SI FECHA_ESTADO == HOY, MOSTRAR "HOY"
                                if (content.fecha_estado === getDateToday()) {
                                    tr.append(
                                        $("<td>")
                                            .html("<strong>Hoy</strong>")
                                            .attr("onclick", "loadServiceData(" + content.id + ")")
                                    );
                                } else {
                                    tr.append(
                                        $("<td>")
                                            .text(content.fecha_estado)
                                            .attr("onclick", "loadServiceData(" + content.id + ")")
                                    );
                                }
                                tr.append(
                                    $("<td>")
                                        .text(content.estado == 0 ? "recibido" : content.estado == 1 ? "en proceso" : content.estado == 2 ? "terminado no entregado" : "entregado")
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                $("#listServices").append(tr);
                            });
                        },
                        error: function (xhr, status) {
                            console.warn("Respuesta:", { status: status, text: xhr.responseJSON['message'] });
                        },
                    });
                }

                function loadServiceData(tableId) { // Cargar detalles del servicio (panel añadir trabajos, modificar estado, cantidad, etc)
                    showModal("showServiceModal");
                    $.ajax({
                        type: "POST",
                        url: "backend/collector.php",
                        data: { action: "servicios_trabajos", serviceId: tableId },
                        dataType: "json",
                        success: function (response) {
                            $("#listServiceDetails").empty();
                            let count = 0;
                            $.each(response.data, function (index, content) {
                                buttonMinus = $("<button>").attr({
                                    id: "substract_" + content.s_id,
                                    class: "btn btn-sm btn-danger",
                                    onclick: "modalServicesSubstract(this, " + content.t_id + "," + content.sd_id + "," + content.sd_cantidad + ")",
                                });
                                buttonMinus.html('<i class="bi bi-dash-lg"></i>');
                                tr = $("<tr>");
                                $(tr).attr('id', content.id);
                                let fechaEstado = content.s_fecha_estado === getDateToday() ? "Hoy" : content.s_fecha_estado;
                                $("#detailServicePanel").html(// Encabezado de ventana modal, presenta todos los datos padre del servicio, cliente, vehículo
                                    $("<div>").addClass("service-card").append(
                                        $('<hidden>').attr({ type: 'hidden', id: 'contextId', serviceId: content.s_id, vehicleId: content.v_id, clientId: content.c_id }),
                                        $("<div>").addClass("service-header").append(
                                            $("<h4>").text(`Servicio #${content.s_id}`),
                                            $("<h6>").html(`<strong>Patente:</strong> ${content.v_patente}`),
                                            $("<h6>").html(`<strong>Propietario:</strong> ${content.apellido_nombre}`)
                                        ),
                                        $("<div>").addClass("service-body").append(
                                            $("<h6>").html(`<strong>Fecha:</strong> ${content.s_fecha}`),
                                            $("<h6>").html(`<strong>Importe total:</strong> $${content.s_importe}`),
                                            $("<h6>").html(`<strong>Estado:</strong> ${content.s_estado == 0 ? "recibido" : content.s_estado == 1 ? "en proceso" : content.s_estado == 2 ? "terminado no entregado" : "entregado"}`),
                                            $("<h6>").html(`<strong>Último cambio:</strong> ${fechaEstado}`)
                                        ),
                                        content.m_nombre ?
                                            $("<h6>").html(`<strong>Modelo:</strong> ${content.m_nombre}`) :
                                            null,
                                        $("<h6>").html(`<strong>Trabajos:</strong> ${response.data[0].t_id == null ? 0 : count = count + 1}`)
                                    )
                                );
                                if (response.data[0].t_id == null) { // NO presenta trabajos asignados?
                                    // console.log('true: ' + response.data[0].t_id);
                                    tr.append($("<td>").text('--'));
                                    tr.append($("<td>").text('--'));
                                    tr.append($("<td>").text('--'));
                                    tr.append($("<td>").text('--'));
                                    tr.append($("<td>").text('--'));
                                    $("#listServiceDetails").append(tr);
                                } else {
                                    // console.log('false: ' + response.data[0].t_id);
                                    tr.append($("<td>").text(index + 1));
                                    tr.append($("<td>").text(content.t_nombre));
                                    tr.append($("<td>").text(content.sd_importe));
                                    tr.append($("<td>").text(content.sd_cantidad));
                                    tr.append($("<td>").append(buttonMinus));
                                    $("#listServiceDetails").append(tr);
                                }
                            });
                            $('#spanCurrentState').text(response.data[0].s_estado == 0 ? "recibido" : response.data[0].s_estado == 1 ? "en proceso" : response.data[0].s_estado == 2 ? "terminado no entregado" : "entregado");
                            $('#showNextState').text(response.data[0].s_estado < 3 ? (response.data[0].s_estado == 0 ? 'en proceso' : response.data[0].s_estado == 1 ? 'terminado no entregado' : 'entregado') : 'N/A');
                            $('#selectTrabajosList').empty();
                            $('#selectTrabajosList').append($('<option>').attr({ disabled: true, selected: true }).text('Seleccione tipo de trabajo - Importe'));
                            response.jobsList.forEach(element => {//Lista de trabajos a disposicion. ORDEN: por importe en orden ascendente (menor precio = mayor demanda)
                                $('#selectTrabajosList').append($('<option>').val(element.id).text(element.nombre + " - Importe: " + element.importe));
                            });
                            $('#btnAddNewJobToService').attr('onclick', 'addNewJobOnServiceSelected(' + response.data[0].s_id + ')');
                        },
                        error: function (xhr, status, error) {
                            console.warn("Respuesta:", { status: status, text: xhr.responseJSON['message'] });
                        },
                    });
                }
                function addNewJobOnServiceSelected(serviceId) { // añadir nuevo trabajo a servicio en ventana modal
                    if (!$('#selectTrabajosList').val()) { // si no presenta trabajo seleccionado en select box
                        let toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        }).fire({
                            icon: 'info',
                            title: 'Primero debe seleccionar un tipo de trabajo.'
                        }); return;
                    } else if ($('#spanCurrentState').text() == 'entregado') { // está entregado el vehículo?
                        let toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        }).fire({
                            icon: 'info',
                            title: 'El servicio ya se encuentra en estado entregado, no se pueden añadir más trabajos.'
                        }); return;
                    } else { // añadir trabajo a servicio
                        $.ajax({
                            type: "POST",
                            url: "backend/collector.php",
                            data: { action: "servicios_agregar", serviceId: serviceId, vehicleId: $('#contextId').attr('vehicleId'), jobId: $('#selectTrabajosList').val(), jobCount: $('#btnCountNewJobToService').data('count') },
                            dataType: "json",
                            success: function (response) {
                                loadServiceData(serviceId);
                            },
                            error: function (xhr, status) {
                                console.warn("Respuesta:", { status: status, text: xhr.responseJSON['message'] });
                            }
                        });
                    }

                }
                function countNewJobToService(element) {
                    // Contador Cantidad de añadir nuevo trabajo, límite 1 / 99
                    const i = 1;
                    let count = $('#btnCountNewJobToService').data('count');
                    if (!$(element).data('count')) {
                        count = count - i;
                    } else {
                        count = count + i;
                    }
                    if (count < 1) {
                        count = 1;
                    } else if (count > 99) {
                        count = 99;
                    }
                    $('#btnCountNewJobToService').children('span').html(count);
                    $('#btnCountNewJobToService').data('count', count);
                }
                function showModal(modalId) { // mostrar modal tomando ID
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(
                        $("#" + modalId)[0]
                    );
                    modalInstance.show();
                }
                function modalServicesSubstract(element, t_id, sd_id, sd_cantidad) {
                    // console.log('Elimina trabajo id:' + t_id + ' de servicio:' + $('#contextId').attr('serviceId') + ' Y detalle de servicio: ' + sd_id);
                    let toast;
                    if ($('#spanCurrentState').text() == 'en proceso' || $('#spanCurrentState').text() == 'recibido' || $('#spanCurrentState').text() == 'entregado') {// solo puede restar trabajos si está marcado como terminado almenos el listado de trabajos actual (terminado no entregado)
                        toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        }).fire({
                            icon: 'info',
                            title: 'El servicio se encuentra fuera del estado "terminado no entregado", primero confirme la finalización de sus trabajos insertados para proceder.'
                        });
                        return;
                    } else {
                        $.ajax({
                            type: "POST",
                            url: "backend/collector.php",
                            data: { action: "servicios_substraerTrabajo", serviceId: $('#contextId').attr('serviceId'), jobId: t_id, serviceDetailId: sd_id, jobCount: sd_cantidad },
                            dataType: "json",
                            success: function (response) {
                                let toast = Swal.mixin({
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 3000,
                                    timerProgressBar: true,
                                    didOpen: (toast) => {
                                        toast.addEventListener('mouseenter', Swal.stopTimer)
                                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                                    }
                                }).fire({
                                    icon: 'info',
                                    title: 'Cantidad del trabajo seleccionado reducida.'
                                });
                                loadServiceData($('#contextId').attr('serviceId'));
                            },
                            error: function (xhr, status) {
                                console.warn("Respuesta:", { status: status, text: xhr.responseJSON['message'] });
                            }
                        });
                    }

                }
                function changeServiceState(element) {// Listado de estados: 0=recibido 1=en proceso 2=terminado no entregado 3=entregado
                    let currentState = $('#spanCurrentState').text();
                    let nextState = '';
                    let toast;
                    let nextStateValue = -1;
                    switch (currentState) {// determina siguiente estado según el actual
                        case 'recibido':
                            toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                            }).fire({
                                icon: 'info',
                                title: 'Primero debe añadir su primer trabajo a realizar.'
                            });
                            return;
                        case 'en proceso':
                            nextState = 'terminado no entregado';
                            nextStateValue = 2;
                            break;
                        case 'terminado no entregado':
                            nextState = 'entregado';
                            nextStateValue = 3;
                            break;
                        case 'entregado':
                            toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                            }).fire({
                                icon: 'info',
                                title: 'El servicio ya se encuentra en estado entregado, no se puede modificar más.'
                            });
                            return;
                        default:
                            console.warn('Estado desconocido.');
                            return;
                    }
                    $.ajax({
                        type: "POST",
                        url: "backend/collector.php",
                        data: { action: "servicios_modificar", serviceId: $('#contextId').attr('serviceId'), newState: nextStateValue },
                        dataType: "json",
                        success: function (response) {
                            loadServiceData($('#contextId').attr('serviceId'));
                        },
                        error: function (xhr, status) {
                            console.warn("Respuesta:", { status: status, text: xhr.responseJSON['message'] });
                        }
                    });
                }
                $('#tableServices th.sortable').on('click', function () {
                    var table = $(this).closest('table');
                    var rows = table.find('tbody > tr').get(); // obtiene todas las filas de la tabla
                    var index = $(this).index();
                    var sortDirection = $(this).data('sortDirection') || 'asc';

                    rows.sort(function (a, b) {//función de comparación automática, maneja texto y números
                        var A = $(a).children('td').eq(index).text().toUpperCase();
                        var B = $(b).children('td').eq(index).text().toUpperCase(); // obtiene el texto de las celdas

                        if ($.isNumeric(A) && $.isNumeric(B)) { // si son números, convierte a float para comparación numérica
                            A = parseFloat(A);
                            B = parseFloat(B);
                        }

                        if (A < B) {
                            return sortDirection === 'asc' ? -1 : 1;// invierte el orden según dirección
                        }
                        if (A > B) {
                            return sortDirection === 'asc' ? 1 : -1;
                        }
                        return 0;
                    });

                    // re organiza filas en tabla
                    $.each(rows, function (idx, row) {
                        table.children('tbody').append(row);
                    });

                    $(this).data('sortDirection', sortDirection === 'asc' ? 'desc' : 'asc'); // invierte data dirección para próximo clic

                    $('#tableServices th').removeClass('asc desc'); // remueve clases de otras columnas previamente seleccionadas
                    $(this).addClass(sortDirection);
                });
                function getDateToday() { // función para comparar fechas, retorna fecha actual en formato YYYY-MM-DD
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                //
            </script>
</body>

</html>