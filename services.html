<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="js/bootstrap-5.3.8-dist/css/bootstrap.min.css">
    <link href="js/bootstrap-5.3.8-dist/bootstrap-icons-1.13.1/bootstrap-icons.css" rel="stylesheet">
    <script src="js/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/sweetalert2-11.26.2/package/dist/sweetalert2.all.min.js"></script>
    <title>Service de vehículos</title>
</head>
<!--
TODO: Añadir filtro para patente, modelo, importe, estado, fecha
TODO: 
-->

<body class="p-3 mb-2 bg-secondary bg-gradient text-white">
    <div>
        <div class="card-header text-center fw-semibold">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Listado de clientes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="services.html">Listado de servicios</a>
                </li>
                <!-- <li class="nav-item">
                    <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
                </li> -->
            </ul>
        </div>
        <div class="card-body p-0">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Filtro de busqueda:</span>
                </div>
                <input type="text" readonly class="form-control" placeholder="Seleccione un filtro primero"
                    id="InputFilterTable">
                <select class="custom-select" id="SelectFilterTable">
                    <option selected value="">⇓ FILTRO ⇓</option>
                    <option value="servicio N°">Numero de Service</option>
                    <option value="Patente">Patente</option>
                    <option value="Modelo">Modelo</option>
                    <option value="Importe">importe</option>
                    <option value="Estado">Estado</option>
                    <option value="dni">DNI</option>
                </select>

            </div>
            <table id="tableServices" class="table table-bordered table-striped table-hover align-middle mb-0">
                <thead class="table-primary text-center">
                    <tr>
                        <th class="col-sm-1">Servicio N°</th>
                        <th class="col col-sm-auto">Nombre y apellido</th>
                        <th class="col col-sm-auto">DNI</th>
                        <th class="col col-sm-1">Patente</th>
                        <th class="col">Modelo</th>
                        <th class="col">Importe</th>
                        <th class="col">Fecha</th>
                        <th class="col-auto">Estado</th>
                    </tr>
                </thead>
                <tbody id="listServices" role="button">
                    <tr>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                    </tr>
                </tbody>
            </table>
            <div class="modal fade" id="showServiceModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="detailServicePanel">Detalles y configuración de servicio:</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-1 ">
                            <div class="table-responsive">
                                <table id="tableListStock"
                                    class="table align-middle table-bordered table-striped table-hover table-sm">
                                    <thead class="table-primary text-center" id="serviceTableHeadDetails">
                                        <tr>
                                            <th>Trabajo N°</th>
                                            <th>Detalle de trabajo</th>
                                            <th>Importe</th>
                                            <th>Cantidad</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider" id="listServiceDetails"></tbody>
                                </table>
                            </div>
                            <div id="serviceActions">
                                <span>Añadir nuevos trabajos al servicio</span>
                                <div style="border: 1px solid black; padding: 1vh; border-radius: 3px;">
                                    <select id="selectTrabajosList">
                                        <option value="0" Disabled selected>Seleccionar trabajos</option>
                                    </select>
                                    <button id="btnCountNewJobToService" data-count="1"
                                        onclick="countNewJobToService(this)"><strong>+</strong><span
                                            id="showCountVal">1</span></button>
                                    <button id="subCountNewJobToService"
                                        onclick="countNewJobToService(this)"><strong>-</strong></button>
                                    <button id="btnAddNewJobToService" class="btn btn-success">Añadir nuevo
                                        trabajo</button>
                                </div>
                                <span>Modificar estado del trabajo</span>
                                <div style="border: 1px solid black; padding: 1vh; border-radius: 3px;">
                                    Estado actual: <strong id="spanCurrentState">Entregado</strong>
                                    <button class="btn btn-success">Cambiar a estado: <span style="color: blue;"
                                            id="showNextState">Terminado</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                loadAllServices();
                $(".modal").on("hidden.bs.modal", function () {
                    $(this).find("input, textarea").val("");
                    loadAllServices();
                });
                $('#SelectFilterTable').change(function (e) {
                    if ($('#SelectFilterTable').val() == '') {
                        loadAllProducts();
                        $("#InputFilterTable").attr({
                            'readonly': true,
                            placeholder: 'Seleccione un filtro primero'
                        });
                    } else {
                        $("#InputFilterTable").show();
                        $("#InputFilterTable").attr({
                            'readonly': false,
                            placeholder: ''
                        });
                    }
                });
                $("#InputFilterTable").on('input', function () {
                    var filter = $(this).val().toUpperCase();
                    var selected = $("#SelectFilterTable").val(); // valor del <select>
                    var tableHead = $("#tableServices");
                    var tableBody = $("#listServices");
                    var tr = tableBody.find("tr");
                    // índice de columna según encabezado
                    var index = -1;
                    if (selected) {
                        tableHead.find("th").each(function (i) {
                            if ($(this).text().toLowerCase() === selected.toLowerCase()) {
                                index = i;
                                return false;
                            }
                        });
                    }

                    tr.each(function () {
                        var tds = $(this).find("td");
                        var found = false;

                        if (index >= 0 && tds.eq(index).length) {
                            // filtra solo por la columna seleccionada
                            var txt = tds.eq(index).text();
                            found = txt.toUpperCase().indexOf(filter) > -1;
                        } else {
                            // si no hay selección, busca en todas las columnas
                            tds.each(function () {
                                if ($(this).text().toUpperCase().indexOf(filter) > -1) {
                                    found = true;
                                    return false;
                                }
                            });
                        }
                        $(this).toggle(found);
                    });
                });
                function loadAllServices() {
                    $.ajax({
                        type: "POST",
                        url: "backend/collector.php",
                        data: { action: "servicios_list" },
                        dataType: "json",
                        success: function (response) {
                            $("#listServices").empty();
                            $.each(response.data, function (index, content) {
                                buttonPlus = $("<button>").attr({
                                    id: "add_" + content.id,
                                    class: "btn btn-sm btn-success me-1",
                                    onclick: "modalAdd(this, " + content.id + ")",
                                });
                                buttonPlus.html('<i class="bi bi-plus-lg"></i>');
                                buttonMinus = $("<button>").attr({
                                    id: "substract_" + content.id,
                                    class: "btn btn-sm btn-danger",
                                    onclick: "modalSubstract(this, " + content.id + ")",
                                });
                                buttonMinus.html('<i class="bi bi-dash-lg"></i>');
                                tr = $("<tr>");
                                tr.append(
                                    $("<td>")
                                        .text(content.id)
                                        .attr({
                                            onclick: "loadServiceData(" + content.id + ")",
                                            id: content.id,
                                        })
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.apellido_nombre)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.DNI)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.patente)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.nombre)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.importe)
                                        .attr({
                                            onclick: "loadServiceData(" + content.id + ")",
                                            class: "text-end"
                                        })
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.fecha)
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.estado == 0 ? "recibido" : content.estado == 1 ? "en proceso" : content.estado == 2 ? "terminado no entregado" : "entregado")
                                        .attr("onclick", "loadServiceData(" + content.id + ")")
                                );
                                $("#listServices").append(tr);
                            });
                        },
                        error: function (xhr, status) {
                            console.warn("Respuesta:", { status: status, text: xhr.responseJSON['message'] });
                        },
                    });
                }

                function loadServiceData(tableId) {
                    showModal("showServiceModal");
                    $.ajax({
                        type: "POST",
                        url: "backend/collector.php",
                        data: { action: "servicios_trabajos", serviceId: tableId },
                        dataType: "json",
                        success: function (response) {
                            $("#listServiceDetails").empty();
                            let count = 0;
                            $.each(response.data, function (index, content) {
                                buttonMinus = $("<button>").attr({
                                    id: "substract_" + content.s_id,
                                    class: "btn btn-sm btn-danger",
                                    onclick: "modalServicesSubstract(this, " + content.s_id + ")",
                                });
                                buttonMinus.html('<i class="bi bi-dash-lg"></i>');
                                tr = $("<tr>");
                                $(tr).attr('id', content.id);
                                $("#detailServicePanel").html(
                                    $("<div>").addClass("service-card").append(
                                        $('<hidden>').attr({ type: 'hidden', id: 'contextId', serviceId: content.s_id, vehicleId: content.v_id, clientId: content.c_id }),
                                        $("<div>").addClass("service-header").append(
                                            $("<h4>").text(`Servicio #${content.s_id}`),
                                            $("<h6>").text(`${content.v_patente}`)
                                        ),
                                        $("<div>").addClass("service-body").append(
                                            $("<p>").html(`<strong>Fecha:</strong> ${content.s_fecha}`),
                                            $("<p>").html(`<strong>Importe total:</strong> $${content.s_importe}`),
                                            $("<p>").html(`<strong>Estado:</strong> ${content.s_estado == 0 ? "recibido" : content.s_estado == 1 ? "en proceso" : content.s_estado == 2 ? "terminado no entregado" : "entregado"}`)
                                        ),
                                        content.m_nombre ?
                                            $("<p>").html(`<strong>Modelo:</strong> ${content.m_nombre}`) :
                                            null,
                                        $("<p>").html(`<strong>Trabajos:</strong> ${count = count + 1}`)
                                    )
                                );
                                tr.append($("<td>").text(index + 1));
                                tr.append($("<td>").text(content.t_nombre));
                                tr.append($("<td>").text(content.sd_importe));
                                tr.append($("<td>").text(content.sd_cantidad));
                                tr.append($("<td>").append(buttonMinus));
                                $("#listServiceDetails").append(tr);
                            });
                            $('#spanCurrentState').text(response.data[0].s_estado == 0 ? "recibido" : response.data[0].s_estado == 1 ? "en proceso" : response.data[0].s_estado == 2 ? "terminado no entregado" : "entregado");
                            $('#selectTrabajosList').empty();
                            $('#selectTrabajosList').append($('<option>').attr({ disabled: true, selected: true }).text('Seleccione tipo de trabajo - Importe'));
                            response.jobsList.forEach(element => {
                                $('#selectTrabajosList').append($('<option>').val(element.id).text(element.nombre + " - Importe: " + element.importe));
                            });
                            $('#btnAddNewJobToService').attr('onclick', 'addNewJobOnServiceSelected(' + response.data[0].s_id + ')');
                        },
                        error: function (xhr, status, error) {
                            console.warn("Respuesta:", { status: status, text: xhr.responseJSON['message'] });
                        },
                    });
                }
                function addNewJobOnServiceSelected(serviceId) {
                    if (!$('#selectTrabajosList').val()) { console.warn('Seleccione primero tipo de trabajo'); return; } else {
                        console.log('Se registra nuevo trabajo:' + $('#selectTrabajosList').val() + 'Para servicio:' + serviceId + ' Cantidad:' + $('#btnCountNewJobToService').data('count'));
                        $.ajax({
                            type: "POST",
                            url: "backend/collector.php",
                            data: { action: "servicios_agregar", serviceId: serviceId, vehicleId: $('#contextId').attr('vehicleId'), jobId: $('#selectTrabajosList').val(), jobCount: $('#btnCountNewJobToService').data('count') },
                            dataType: "json",
                            success: function (response) {

                            },
                            error: function (xhr, status) {
                                console.warn("Respuesta:", { status: status, text: xhr.responseJSON['message'] });
                            }
                        });
                    }

                }
                function countNewJobToService(element) {
                    // Contador Cantidad de añadir nuevo trabajo, límite 1 / 99
                    const i = 1;
                    let count = $('#btnCountNewJobToService').data('count');
                    if (!$(element).data('count')) {
                        count = count - i;
                    } else {
                        count = count + i;
                    }
                    if (count < 1) {
                        count = 1;
                    } else if (count > 99) {
                        count = 99;
                    }
                    $('#btnCountNewJobToService').children('span').html(count);
                    $('#btnCountNewJobToService').data('count', count);
                }
                function showModal(modalId) {
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(
                        $("#" + modalId)[0]
                    );
                    modalInstance.show();
                }

            </script>
</body>

</html>