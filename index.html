<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="js/bootstrap-5.3.8-dist/css/bootstrap.min.css">
    <link href="js/bootstrap-5.3.8-dist/bootstrap-icons-1.13.1/bootstrap-icons.css" rel="stylesheet">
    <script src="js/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/sweetalert2-11.26.2/package/dist/sweetalert2.all.min.js"></script>
    <title>Service de vehículos</title>
</head>

<body class="p-3 mb-2 bg-secondary bg-gradient text-white">
    <div>
        <div class="card-header text-center fw-semibold">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="index.html">Listado de clientes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="services.html">Listado de servicios</a>
                </li>
            </ul>
        </div>
        <div class="card-body p-0">
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text">Filtro de busqueda:</span>
                </div>
                <input type="text" readonly class="form-control" placeholder="Seleccione un filtro primero"
                    id="InputFilterTable">
                <select class="custom-select" id="SelectFilterTable">
                    <option selected value="">⇓ FILTRO ⇓</option>
                    <option value="dni">DNI</option>
                    <option value="nombre y apellido">Nombre y apellido</option>
                    <option value="Email">EMAIL</option>
                    <option value="movil">MOVIL</option>
                    <option value="observaciones">OBSERVACIONES</option>
                </select>

            </div>
            <table id="tableClients" class="table table-bordered table-striped table-hover align-middle mb-0">
                <thead class="table-primary text-center">
                    <tr>
                        <th>Usuario N°</th>
                        <th>Nombre y apellido</th>
                        <th>DNI</th>
                        <th>Telefono</th>
                        <th>Email</th>
                        <th>Obervaciones</th>
                        <th>Movil</th>
                        <th class="col-auto">Acción</th>
                    </tr>
                </thead>
                <tbody id="listClients" role="button">
                    <tr>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                        <td>Cargando...</td>
                    </tr>
                </tbody>
            </table>
            <div class="modal fade" id="addStockModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content text-bg-secondary">

                        <div class="modal-header">
                            <h5 class="modal-title">Añadir nuevo servicio</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    Cliente seleccionado: <strong><label id="clientContentAddService"></label></strong>
                                </li>
                                <li class="list-group-item">
                                    Vehículo seleccionado: <strong><label id="vehicleContentAddService"
                                            data-v_id="">---</label></strong><br>
                                    Seleccionar otro vehículo: <select id="selectOtherVehicle"
                                        class="form-select"></select>
                                </li>

                                <li class="list-group-item">
                                    Fecha: <input type="date" id="serviceDate" class="form-control">
                                </li>
                                <li class="list-group-item">
                                    Importe inicial del servicio: <input type="number" id="serviceValue"
                                        class="form-control" value="0">
                                </li>
                            </ul>
                        </div>

                        <div class="modal-footer">
                            <button id="addNewStockBtn" class="btn btn-success">
                                <i class="bi bi-plus-lg"></i> Agregar
                            </button>
                        </div>

                    </div>
                </div>
            </div>
            <div class="modal fade" id="showStockModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="productNameStock">Situación de Stock</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0">
                            <div class="table-responsive">
                                <table id="tableListStock"
                                    class="table align-middle table-bordered table-striped table-hover table-sm">
                                    <thead class="table-primary text-center">
                                        <tr>
                                            <th style="width:5%;">Servicio N°</th>
                                            <th class="text-nowrap" style="width:15%;">Fecha</th>
                                            <th class="text-nowrap" style="width:15%;">Patente</th>
                                            <th class="text-nowrap" style="width:20%;">Modelo</th>
                                            <th class="text-nowrap" style="width:15%;">Monto Total</th>
                                            <th style="width:15%;">Fecha estado actual</th>
                                            <th class="text-nowrap" style="width:15%;">Estado actual</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-group-divider" id="listStock"></tbody>
                                </table>
                            </div>
                            <div id="showBtnAddNewServiceShortcut"></div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                loadAllClients();
                $(".modal").on("hidden.bs.modal", function () {
                    $(this).find("input, textarea").val("");
                    $(this).find("#selectOtherVehicle").empty();
                    $(this).find("#vehicleContentAddService").text('---').attr('data-v_id', '');
                    loadAllClients();
                });
                $('#SelectFilterTable').change(function (e) {
                    if ($('#SelectFilterTable').val() == '') {
                        loadAllProducts();
                        $("#InputFilterTable").attr({
                            'readonly': true,
                            placeholder: 'Seleccione un filtro primero'
                        });
                    } else {
                        $("#InputFilterTable").show();
                        $("#InputFilterTable").attr({
                            'readonly': false,
                            placeholder: ''
                        });
                    }
                });
                $("#selectOtherVehicle").change(function (e) {
                    var selectedVehicleId = $(this).val();
                    var selectedVehicleText = $(this).find("option:selected").text();
                    $("#vehicleContentAddService").text(selectedVehicleText).attr('data-v_id', selectedVehicleId);
                });
                $("#InputFilterTable").on('input', function () {
                    var filter = $(this).val().toUpperCase();
                    var selected = $("#SelectFilterTable").val(); // valor del <select>
                    var tableHead = $("#tableClients");
                    var tableBody = $("#listClients");
                    var tr = tableBody.find("tr");
                    // índice de columna según encabezado
                    var index = -1;
                    if (selected) {
                        tableHead.find("th").each(function (i) {
                            if ($(this).text().toLowerCase() === selected.toLowerCase()) {
                                index = i;
                                return false;
                            }
                        });
                    }

                    tr.each(function () {
                        var tds = $(this).find("td");
                        var found = false;

                        if (index >= 0 && tds.eq(index).length) {
                            // filtra solo por la columna seleccionada
                            var txt = tds.eq(index).text();
                            found = txt.toUpperCase().indexOf(filter) > -1;
                        } else {
                            // si no hay selección, busca en todas las columnas
                            tds.each(function () {
                                if ($(this).text().toUpperCase().indexOf(filter) > -1) {
                                    found = true;
                                    return false;
                                }
                            });
                        }
                        $(this).toggle(found);
                    });
                });
                function loadAllClients() {
                    $.ajax({
                        type: "POST",
                        url: "backend/collector.php",
                        data: { action: "clientes_list" },
                        dataType: "json",
                        success: function (response) {
                            $("#listClients").empty();
                            $.each(response.data, function (index, content) {
                                buttonPlus = $("<button>").attr({
                                    id: "add_" + content.id,
                                    class: "btn btn-sm btn-success me-1",
                                    onclick: "modalAddService(this, " + content.id + ")",
                                });
                                buttonPlus.html('<i class="bi bi-plus-lg"></i>');
                                tr = $("<tr>");
                                tr.append(
                                    $("<td>")
                                        .text(content.id)
                                        .attr({
                                            onclick: "loadClientsData(" + content.id + ")",
                                            id: content.id,
                                        })
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.apellido_nombre)
                                        .attr("onclick", "loadClientsData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.DNI)
                                        .attr("onclick", "loadClientsData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.te_linea)
                                        .attr("onclick", "loadClientsData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.email)
                                        .attr("onclick", "loadClientsData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.observaciones)
                                        .attr("onclick", "loadClientsData(" + content.id + ")")
                                );
                                tr.append(
                                    $("<td>")
                                        .text(content.movil)
                                        .attr("onclick", "loadClientsData(" + content.id + ")")
                                );
                                tr.append($("<td>").append(buttonPlus).attr({ class: "text-center" }));
                                $("#listClients").append(tr);
                            });
                        },
                        error: function (xhr, status, error) {
                            console.warn("Respuesta: " + status + "\n" + error);
                        },
                    });
                }

                function loadClientsData(tableId) {
                    showModal("showStockModal");
                    $.ajax({
                        type: "POST",
                        url: "backend/collector.php",
                        data: { action: "clientes_servicios", clientId: tableId },
                        dataType: "json",
                        success: function (response) {
                            $("#listStock").empty();
                            $("#productNameStock").empty();
                            $("#showBtnAddNewServiceShortcut").empty();
                            var th, tr, buttonPlus, buttonRewind;
                            buttonPlus = $("<button>").attr({
                                id: "add_" + response.data[0].c_id,
                                class: "btn btn-sm btn-success me-1",
                                onclick: "modalAddService(this, " + response.data[0].c_id + "," + response.data[0].v_id + ")",
                            });
                            buttonPlus.html('<i class="bi bi-plus-lg">Añadir Nuevo Servicio</i>');
                            $("#showBtnAddNewServiceShortcut").append(buttonPlus);
                            if (response.data.every(item => item.s_id == null)) {// Si todos los vehículos del cliente no tienen servicios asociados
                                $("#productNameStock").append(
                                    $("<h6>").text("Cliente: " + response.data[0].apellido_nombre + " (Todos sus vehículos no tienen servicios asociados)"),
                                    $("<h6>").text(" En caso de que desee añadir nuevos servicios, por favor cierre este modal y utilice el botón '+' en la tabla de clientes.")
                                );
                                th = $("<tr>");
                                th.append($("<th>").text('Vehículo N°'));
                                th.append($("<th>").text('Patente'));
                                th.append($("<th>").text('Modelo'));
                                th.append($("<th>").text('Añadir servicio'));
                                $('#tableListStock thead').html(th).attr({
                                    class: 'table-primary text-center'
                                });
                                $.each(response.data, function (index, content) {
                                    buttonPlus = $("<button>").attr({
                                        id: "add_" + content.c_id,
                                        class: "btn btn-sm btn-success me-1",
                                        onclick: "modalAddService(this, " + content.c_id + "," + content.v_id + ")",
                                    });
                                    buttonPlus.html('<i class="bi bi-plus-lg"></i>');
                                    tr = $("<tr>");
                                    $(tr).attr('id', content.id);
                                    tr.append($("<td>").text(content.v_id));
                                    tr.append($("<td>").text(content.patente));
                                    tr.append($("<td>").text(content.nombre));
                                    tr.append($("<td>").append(buttonPlus).attr({ class: "text-center" }));
                                    $("#listStock").append(tr);
                                });
                            } else {
                                $("#productNameStock").html($("<label>").text("Cliente: " + response.data[0].apellido_nombre));
                                th = $("<tr>");
                                th.append($("<th>").text('Servicio N°'));
                                th.append($("<th>").text('Fecha')).addClass('text-center text-nowrap');
                                th.append($("<th>").text('Patente'));
                                th.append($("<th>").text('Modelo'));
                                th.append($("<th>").text('Monto Total'));
                                th.append($("<th>").text('Fecha estado actual'));
                                th.append($("<th>").text('Estado actual'));
                                th.append($("<th>").text('Ir a servicio'));
                                $('#tableListStock thead').html(th).attr({
                                    class: 'table-primary text-center'
                                });
                                $.each(response.data, function (index, content) {
                                    buttonRewind = $("<button>").attr({
                                        id: "rewind_" + content.id,
                                        class: "btn btn-sm btn-danger ",
                                        onclick: "actionRewindStock(this, " + content.id + ")",
                                    });
                                    buttonRewind.html('<i class="bi bi-x-lg"></i>');
                                    tr = $("<tr>");
                                    tr.append($("<td>").text(content.v_id ? content.v_id : 'Sin servicio asociado')); // fila Nro:
                                    tr.append($("<td>").text(content.fecha ? content.fecha : '--')); // fecha
                                    tr.append($("<td>").text(content.patente));
                                    tr.append($("<td>").text(content.nombre));
                                    tr.append($("<td>").text((content.importe != null) ? content.importe : '--').attr({ class: 'text-end' }));
                                    tr.append($("<td>").html(content.fecha_estado ? content.fecha_estado : '--'));
                                    tr.append($("<td>").text(content.estado == 0 ? "recibido" : content.estado == 1 ? "en proceso" : content.estado == 2 ? "terminado no entregado" : content.estado == 3 ? "entregado" : "--"));
                                    content.s_id ? tr.append($("<td>").html($('<a>').text("Ver servicio").attr("href", "/services.html?id=" + content.s_id + "&isservice=true"))) : tr.append($("<td>").text("--"));
                                    $("#listStock").append(tr);
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.warn("Respuesta: " + status + "\n" + error);
                        },
                    });
                }
                function modalAddService(el, clientId, vehicleId) {
                    if (vehicleId) {
                        showModal("addStockModal");
                        $('#showStockModal').modal('hide');
                        $.ajax({
                            type: "POST",
                            url: "backend/collector.php",
                            data: { action: "clientes_nuevo", clientId: clientId, vehicleId: vehicleId },
                            dataType: "json",
                            success: function (response) {
                                $("#clientContentAddService").text(
                                    response.client.apellido_nombre +
                                    " - DNI: " +
                                    response.client.DNI
                                );
                                $("#vehicleContentAddService").text(
                                    "Patente: " +
                                    response.selectedVehicle.patente +
                                    " - Modelo: " +
                                    response.selectedVehicle.nombre
                                ).attr('data-v_id', response.selectedVehicle.v_id);
                                var selectOtherVehicle = $("#selectOtherVehicle");
                                selectOtherVehicle.empty();
                                selectOtherVehicle.append(
                                    $("<option>").val("").text("⇓ Cambiar vehículo pre-seleccionado ⇓").attr({ selected: true, disabled: true }));
                                $.each(response.vehicles, function (index, vehicle) {
                                    var option = $("<option>")
                                        .val(vehicle.v_id)
                                        .text(
                                            "Patente: " +
                                            vehicle.patente +
                                            " - Modelo: " +
                                            vehicle.nombre
                                        );
                                    selectOtherVehicle.append(option);
                                });
                                $("#addNewStockBtn").attr(
                                    "onclick",
                                    "addNewServiceToclientVehicle(" + clientId + ", $('#vehicleContentAddService').attr('data-v_id')" + ")"
                                );
                            },
                            error: function (xhr, status, error) {
                                console.warn("Respuesta: " + status + "\n" + error);
                            },
                        });
                        return;
                    } else {
                        showModal("addStockModal");
                        $.ajax({
                            type: "POST",
                            url: "backend/collector.php",
                            data: { action: "clientes_nuevo", clientId: clientId },
                            dataType: "json",
                            success: function (response) {
                                $("#clientContentAddService").text(
                                    response.client.apellido_nombre +
                                    " - DNI: " +
                                    response.client.DNI
                                );
                                var selectOtherVehicle = $("#selectOtherVehicle");
                                selectOtherVehicle.empty();
                                selectOtherVehicle.append(
                                    $("<option>").val("").text("⇓ Seleccione un vehículo ⇓").attr({ selected: true, disabled: true }));
                                $.each(response.vehicles, function (index, vehicle) {
                                    var option = $("<option>")
                                        .val(vehicle.v_id)
                                        .text(
                                            "Patente: " +
                                            vehicle.patente +
                                            " - Modelo: " +
                                            vehicle.nombre
                                        );
                                    selectOtherVehicle.append(option);
                                });

                                $("#addNewStockBtn").attr(
                                    "onclick",
                                    "addNewServiceToclientVehicle(" + clientId + ", $('#vehicleContentAddService').attr('data-v_id')" + ")"
                                );
                            },
                            error: function (xhr, status, error) {
                                console.warn("Respuesta: " + status + "\n" + error);
                            },
                        });
                    }
                }
                function addNewServiceToclientVehicle(clientId, vehicleId) {
                    console.log("Agregar nuevo servicio para clienteId: " + clientId + ", vehicleId: " + vehicleId);
                    $.ajax({
                        type: "POST",
                        url: "backend/collector.php",
                        data: {
                            action: "clientes_servicioAgregar",
                            clientId: clientId,
                            vehicleId: vehicleId,
                            fecha: $("#serviceDate").val(),
                            importe: $("#serviceValue").val(),
                        },
                        dataType: "json",
                        success: function (response) {
                            if (response.status === "success") {// Se presenta alerta, con opción para ir al servicio nuevo creado
                                Swal.fire({
                                    icon: "success",
                                    title: "Servicio agregado",
                                    text: "El nuevo servicio ha sido agregado exitosamente.",
                                    showCancelButton: true,
                                    confirmButtonText: "Ir al servicio",
                                    cancelButtonText: "Cerrar",
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = "/services.html?id=" + response.serviceId + "&isservice=true";
                                    }
                                });
                                $('#addStockModal').modal('hide');
                            } else {
                                Swal.fire({
                                    icon: "error",
                                    title: "Error",
                                    text: response.message || "Hubo un error al agregar el servicio.",
                                    confirmButtonText: "Aceptar"
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.warn("Respuesta: " + status + "\n" + error);
                        },
                    });
                }
                function showModal(modalId) { // muestra el modal basado en su ID
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(
                        $("#" + modalId)[0]
                    );
                    modalInstance.show();
                }

            </script>
</body>

</html>